FROM amazoncorretto:21-alpine

RUN apk add --no-cache wget

ARG JAR_FILE

ENV SPRING_APPLICATION_NAME=$SPRING_APPLICATION_NAME \
    SERVER_SERVLET_CONTEXT_PATH=$SERVER_SERVLET_CONTEXT_PATH \
    LOGGING_LEVEL_APP_SPORTAHUB=$LOGGING_LEVEL_APP_SPORTAHUB \
    LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB=$LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB \
    KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID \
    KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET \
    KEYCLOAK_REDIRECT_URI=$KEYCLOAK_REDIRECT_URI \
    KEYCLOAK_ISSUER_URI=$KEYCLOAK_ISSUER_URI \
    KEYCLOAK_TOKEN_URI=$KEYCLOAK_TOKEN_URI \
    KEYCLOAK_AUTHORIZATION_URI=$KEYCLOAK_AUTHORIZATION_URI \
    KEYCLOAK_USER_INFO_URI=$KEYCLOAK_USER_INFO_URI \
    KEYCLOAK_JWK_SET_URI=$KEYCLOAK_JWK_SET_URI \
    JWT_ISSUER_URI=$JWT_ISSUER_URI \
    KEYCLOAK_AUTH_SERVER_URL=$KEYCLOAK_AUTH_SERVER_URL \
    KEYCLOAK_REALM=$KEYCLOAK_REALM \
    MONGODB_URI=$MONGODB_URI

COPY ${JAR_FILE} /app.jar

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD wget --quiet --spider http://localhost:8080${SERVER_SERVLET_CONTEXT_PATH}/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "/app.jar", "--server.port=${SERVER_PORT}"]
